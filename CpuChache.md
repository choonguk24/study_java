## CPU緩存和內存屏障

### CPU性能优化手段 - 缓存
为了提高程序运行的性能。（加快处理器访问主内存的速度）
- cpu的缓存： 多级缓存
- 运行时指令重排

### 缓存同步协议
- MESI协议，它规定每条缓存有个状位，定义了4个状态。  
    - 修改态
    - 专有态
    - 共享态
    - 无效态
- 多处理器时，单个CPU对缓存中数据进行了改动，需要通知给其它CPU。也就是CPU处理要控制自己的读写操作，还要监听其它CPU发出的通知，从而保证最终一致。

### 运行时指令重排
- 指令重排的场景：当CPU写缓存时发现缓存区块正呗其它CPU占用，为了提高CPU处理性能，可能将后面的读缓存命令有限执行。
- as-if-serial： 不管怎么重排序（编译器和处理器为了提高并行度）。编译器，runtime和处理器都必须遵循as-ifserial，也就是说：编译器和处理器不会对存在数据依赖关系的操作做重排序（保证执行结果的一致性）。

### 两个问题
1. CPU高速缓存下，缓存中的数据与主内存的数据并不是实时同步的，各CPU之间的缓存的数据也不是实时同步。在同一个时间点，各CPU所看到同一内存地址的数据的值可能不一致。
2. CPU指令重排优化下，虽然遵循as-if-serial语义，单仅在单CPU自己执行的情况下能保证结果正确。多核多线程中，指令逻辑无法分辨因果关联，可能出现乱序执行，导致程序运行结果错误。

### 内存屏障
强制CPU直接在主内存进行读写操作，进而解决上述问题。
- 写内存屏障
- 读内存屏障  
